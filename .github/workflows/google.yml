name: Google Branch

on:
  push:
    branches: [google-cloud-def]

env:
  BILLING_ACCOUNT: "01AEBE-A2F4CA-DC0648"
  REGION: "europe-north1"
  PROJECT: "fvst-staging-7"

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - uses: "actions/checkout@v3"

      - name: "Unpack Key"
        id: "google-key"
        run: |
          GOOGLE_CLOUD_TOKEN=$(echo ${{secrets.GOOGLE_CLOUD_TOKEN}} | base64 --decode)
          echo "GOOGLE_CLOUD_TOKEN=$GOOGLE_CLOUD_TOKEN" >> $GITHUB_OUTPUT

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v1"
        with:
          credentials_json: ${{steps.google-key.outputs.GOOGLE_CLOUD_TOKEN}}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"
        with:
          version: ">= 417.0.0"

      - name: Info
        run: gcloud info

      - name: "Create Project"
        run: |
          gcloud projects create $PROJECT --name "FVST Staging" --folder=370540016741 --set-as-default
          gcloud config set project $PROJECT
          gcloud info

      - name: "Install support components"
        run: |
          gcloud --project $PROJECT components install alpha 
          gcloud --project $PROJECT components install beta

      - name: "Configure billing"
        run: |
          gcloud --project $PROJECT services enable cloudbilling.googleapis.com
          gcloud alpha billing projects link $PROJECT --billing-account 01AEBE-A2F4CA-DC0648

      - name: "Turn on features"
        run: |
          gcloud --project $PROJECT services enable compute.googleapis.com sqladmin.googleapis.com run.googleapis.com containerregistry.googleapis.com cloudbuild.googleapis.com servicenetworking.googleapis.com vpcaccess.googleapis.com

      - name: "Provision PostgreSQL"
        run: gcloud --project $PROJECT sql instances create fvst-primary-db --database-version=POSTGRES_14 --cpu=1 --memory=4GB --region=$REGION --root-password=fvst

      - name: "Create Database"
        run: gcloud --project $PROJECT sql databases create fvst --instance=fvst-primary-db

      - name: "Create Database User"
        run: gcloud --project $PROJECT sql users create fvst --instance=fvst-primary-db --password=fvst
