name: Terraform apply
on:
  push:
    branches:
      - develop
      - main
    paths:
      - "infra/**"

jobs:
  deploy-staging:
    if: ${{ github.ref == 'refs/heads/develop' }}
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v3"

      - uses: ./.github/actions/setup-google-cloud-auth
        id: "auth"
        with:
          google_cloud_token: ${{ secrets.GOOGLE_CLOUD_TOKEN_STAGING }}

      - uses: ./.github/actions/terraform-apply
        with:
          environment: "staging"
          terraform-bucket: ${{ vars.FVST_PROJECT_TF_STATE_BUCKET_STAGING }}
          region: ${{ vars.FVST_PROJECT_REGION }}
          prefix: ${{ vars.FVST_PROJECT_PREFIX }}

  deploy-production:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v3"

      - uses: ./.github/actions/setup-google-cloud-auth
        id: "auth"
        with:
          google_cloud_token: ${{ secrets.GOOGLE_CLOUD_TOKEN_PRODUCTION }}

      - uses: ./.github/actions/terraform-apply
        with:
          environment: "production"
          terraform-bucket: ${{ vars.FVST_PROJECT_TF_STATE_BUCKET_PRODUCTION }}
          region: ${{ vars.FVST_PROJECT_REGION }}
          prefix: ${{ vars.FVST_PROJECT_PREFIX }}
