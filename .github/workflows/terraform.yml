name: Terraform
on: [push]

env:
  GH_TOKEN: ${{github.event.inputs.github-token }}

jobs:
  initialize:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - environment: staging
            google_cloud_token: GOOGLE_CLOUD_TOKEN_STAGING
          - environment: production
            google_cloud_token: GOOGLE_CLOUD_TOKEN_PRODUCTION

    env:
      PROJECT: ${{ secrets.FVST_PROJECT_PREFIX }}-fvst-${{matrix.environment}}
      GOOGLE_CLOUD_TOKEN_ENV: ${{ secrets[matrix.google_cloud_token] }}

    steps:
      - uses: "actions/checkout@v3"

      - name: Print info
        run: |
          echo "Using $PROJECT as project"

      - name: "Unpack Key"
        id: "google-key"
        run: |
          GOOGLE_CLOUD_TOKEN=$(echo $GOOGLE_CLOUD_TOKEN_ENV | base64 --decode)
          echo "GOOGLE_CLOUD_TOKEN=$GOOGLE_CLOUD_TOKEN" >> $GITHUB_OUTPUT

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v1"
        with:
          credentials_json: "${{steps.google-key.outputs.GOOGLE_CLOUD_TOKEN}}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"

      - name: Info
        run: gcloud info
